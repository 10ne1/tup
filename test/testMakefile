srcs := $(wildcard *.c)
objs := $(srcs:.c=.o)
prog := prog

# Change the directory "." to nothing - all other actual directory names get
# a / appended
d := $(if $(filter .,$(TUPWD)),,$(TUPWD)/)

ifneq (,$(strip $(objs)))
$(prog): $(objs)
	@echo "Link '$(patsubst %,$d%,$^)' into '$d$@'"; \
	tup link "tup wrap gcc $(patsubst %,$d%,$^) -o $d$@" $(foreach f,$^,-i$f) -o$@
endif

$(objs): %.o: %.c
	@echo "Compile '$d$<' into '$d$@'"; \
	tup link "tup wrap gcc -c $d$< -o $d$@" -i$< -o$@

default: ; @true

.PHONY: $(prog) $(srcs) $(objs) default
