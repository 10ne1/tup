srcs := $(wildcard *.c)
objs := $(srcs:.c=.o)
prog := prog

# Change the directory "." to nothing - all other actual directory names get
# a / appended
d := $(if $(filter .,$(TUPWD)),,$(TUPWD)/)

$(prog): $(objs)
	@if [ "x$^" != "x" ]; then \
	echo "Link '$(patsubst %,$d%,$^)' into '$d$@'"; \
	tup command "tup wrap gcc $(patsubst %,$d%,$^) -o $d$@" && \
	$(foreach f,$^,tup input $f "tup wrap gcc $(patsubst %,$d%,$^) -o $d$@" &&) \
	tup output "tup wrap gcc $(patsubst %,$d%,$^) -o $d$@" $@; \
	fi
$(objs): %.o: %.c
	@echo "Compile '$d$<' into '$d$@'"; \
	tup command "tup wrap gcc -c $d$< -o $d$@" && \
	tup input $< "tup wrap gcc -c $d$< -o $d$@" && \
	tup output "tup wrap gcc -c $d$< -o $d$@" $@

.PHONY: $(prog) $(srcs) $(objs)
